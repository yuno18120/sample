<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>加速度センサー</title>

    <style type="text/css">
        html,
        body {
            text-align: center;
            background-color: #fafafa;
            font-size: 20px;
            color: #333;
        }

        body {
            background-color: #ffffcc;
        }

        #mycanvas {
            border: 1px solid #333;
            background-color: #ffcccc;
        }
    </style>
</head>

<body>

    <div class="container">
        <canvas id="mychart1" style="position:relative; width:90%; height: 30%;"></canvas>
        <canvas id="mychart2" style="position:relative; width:90%; height: 30%;"></canvas>

        <div id="cdiv">
            <canvas width="80%" height="30%" id="mycanvas"></canvas>
        </div>
    </div>

    <script>
        var isTouch = false;
        var motionData = [];
        var orientationData = [];

        function ClickRequestDeviceSensor() {
            DeviceOrientationEvent.requestPermission().then(function (response) {
                if (response === 'granted') {
                    window.addEventListener("deviceorientation", deviceOrientation);
                }
            });

            DeviceMotionEvent.requestPermission().then(function (response) {
                if (response === 'granted') {
                    window.addEventListener("devicemotion", deviceMotion);
                }
            })
        }

        $(function () {
            init();
        });

        function init() {
            var canvas = document.getElementById('mycanvas');
            if (!canvas || !canvas.getContext) {
                return false;
            }

            if (window.DeviceOrientationEvent) {
                if (DeviceOrientationEvent.requestPermission && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    $('#cdiv').css('display', 'none');
                    var banner = '<div id="sensorrequest" onclick="ClickRequestDeviceSensor();" style="z-index:1; position:absolute; width:100%; background-color:#000; color:#fff;><p style="padding:10px;">センサーの有効化</p></div>';
                    $('body').prepend(banner);
                } else {
                    window.addEventListener("deviceorientation", deviceOrientation);
                }
            }
            if (window.DeviceMotionEvent) {
                if (DeviceMotionEvent.requestPermission && typeof DeviceMotionEvent.requestPermission === 'function') {
                } else {
                    window.addEventListener("devicemotion", deviceMotion);
                }
            }

            if (window.TouchEvent) {
                canvas.addEventListener("touchstart", touchStart);
                canvas.addEventListener("touchend", touchEnd);
            }

            //. リサイズ時に Canvas サイズを変更する
            $(window).on('load resize', function () {
                resized();
            });
            resized();

            //. スクロール禁止
            /*
            $(window).on('touchmove.noScroll', function( e ){
              e.preventDefault();
            });
            */
            var movefun = function (event) {
                event.preventDefault();
            }
            window.addEventListener('touchmove', movefun, { passive: false });
        }

        var canvas_width = 0;
        var canvas_height = 0;
        function resized() {
            var browserWidth = window.innerWidth;
            var browserHeight = window.innerHeight;
            var canvas = document.getElementById('mycanvas');
            if (canvas && canvas.getContext) {
                canvas.width = canvas_width = browserWidth * 0.8;
                canvas.height = canvas_height = browserHeight * 0.4;
            }
        }

        function touchStart(e) {
            e.preventDefault();
            isTouch = true;
            motionData = [];
            orientationData = [];
        }

        function touchEnd(e) {
            e.preventDefault();
            isTouch = false;

            if (motionData && motionData.length > 0) {
                //. グラフ描画
                var labels = [];
                var x_data = [];
                var y_data = [];
                var z_data = [];
                for (var i = 0; i < motionData.length; i++) {
                    var mot = motionData[i];
                    labels.push('' + i);
                    x_data.push(mot['ac'].x);
                    y_data.push(mot['ac'].y);
                    z_data.push(mot['ac'].z);
                }
            }

            if (orientationData && orientationData.length > 0) {
                //. グラフ描画
                var labels = [];
                var fb_data = [];
                var lr_data = [];
                var dir_data = [];
                for (var i = 0; i < orientationData.length; i++) {
                    var ori = orientationData[i];
                    labels.push('' + i);
                    fb_data.push(ori['fb']);
                    lr_data.push(ori['lr']);
                    dir_data.push(ori['dir']);
                }
            }
        }

        function deviceMotion(e) {
            e.preventDefault();
            if (isTouch) {
                var ac = e.acceleration;
                var acg = e.accelerationIncludingGravity;
                var rot = e.rotationRate;

                var motion = {};
                motion['ac'] = ac;
                motion['acg'] = acg;
                motion['rot'] = rot;

                motionData.push(motion);
            }
        }
        function deviceOrientation(e) {
            e.preventDefault();
            if (isTouch) {
                var gamma = e.gamma; //. Left/Right
                var beta = e.beta;   //. Front/Back
                var alpha = e.alpha; //. Direction

                var ori = {};
                ori['dir'] = alpha;
                ori['fb'] = beta;
                ori['lr'] = gamma;

                orientationData.push(ori);
            }
        }
    </script>
</body>

</html>